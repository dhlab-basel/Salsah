<!--
 the user form is a step by step form, which will be used in system and project admin
 to create new user, to edit existing users or/and to add user to or remove from projects

 the steps (depending on the usage / route) are as follow:
    1) user profile
        a) in case of project admin: select existing user OR create new user profile => b)
        b) in case of system admin: create new user profile (or edit old one?)

    2) project membership
        a) in case of system admin: select project AND set the permissions => b)
        b) in case of project admin: set permissions

    3) special stuff like "add the user to system project" and set system permissions

-->


<div class="salsah-step-by-step-form">
    <!-- form header with form stepper -->
    <!--
    <div class="salsah-form-stepper">
        <salsah-progress-stepper *ngIf="steps || max_steps" [steps]="steps"
                                 [counter]="counter"></salsah-progress-stepper>
    </div>
    <br>
    -->

    <salsah-progress-indicator *ngIf="isLoading"></salsah-progress-indicator>

    <div class="salsah-form-content" *ngIf="!isLoading">
        <mat-accordion class="headers-align">

            <!-- 1) user profile -->
            <!-- 1a) view: project admin: select existing user OR create new user profile => b) -->
            <mat-expansion-panel [expanded]="step === 0" *ngIf="restrictedBy && !form.valid"
                                (opened)="setStep(0)"
                                hideToggle="true">
                <!-- header -->
                <mat-expansion-panel-header>
                    <mat-panel-title>
                        <span *ngIf="!selectedUser">{{formLabels.user.select.title}}</span>
                        <span *ngIf="selectedUser">{{formLabels.user.select.titleDone}}</span>
                    </mat-panel-title>
                    <mat-panel-description>
                        <span *ngIf="!selectedUser">{{formLabels.user.select.description}}</span>
                        <span *ngIf="selectedUser"><i>{{selectedUser.userData?.givenName}} {{selectedUser.userData?.familyName}}</i></span>
                        <mat-icon>person</mat-icon>
                    </mat-panel-description>
                </mat-expansion-panel-header>
                <mat-form-field class="large">
                    <input matInput
                           [placeholder]="formLabels.user.select.autoComplete"
                           [matAutocomplete]="autoUser"
                           [formControl]="userCtrl">
                    <mat-icon matSuffix class="input-icon icon-for-autocomplete" (click)="resetSelectedUser()"
                             *ngIf="userCtrl.value && userCtrl.dirty">close
                    </mat-icon>
                    <mat-autocomplete #autoUser="matAutocomplete"> <!-- [displayWith]="displayFn"> -->
                        <mat-option *ngFor="let user of filteredUsers | async" [value]="user?.name"
                                   (onSelectionChange)="setSelectedUser($event, user?.iri)">
                            {{ user?.name }}
                        </mat-option>
                    </mat-autocomplete>
                </mat-form-field>
                <!-- footer -->
                <mat-action-row>
                    <button mat-button *ngIf="!selectedUser"
                            class="navigation-button left"
                            color="warn"
                            (click)="nextStep($event)">
                        {{formLabels.user.select.skip}}
                    </button>
                    <button mat-button *ngIf="restrictedBy"
                            class="navigation-button"
                            color="primary"
                            (click)="nextStep($event, 3)"
                            [disabled]="!userCtrl.valid">
                        {{formLabels.navigation.next}}
                    </button>
                    <button mat-button *ngIf="!restrictedBy"
                            class="navigation-button"
                            color="primary"
                            (click)="nextStep($event, 2)"
                            [disabled]="!userCtrl.valid">
                        {{formLabels.navigation.next}}
                    </button>
                </mat-action-row>
            </mat-expansion-panel>

            <!-- 1b) view: project and system admin: create new user profile (or edit old one?) -->
            <mat-expansion-panel [expanded]="step === 1" *ngIf="!selectedUser && !userCtrl.value"
                                (opened)="setStep(1)"
                                hideToggle="true">
                <!-- header -->
                <mat-expansion-panel-header>
                    <mat-panel-title>
                        <span *ngIf="restrictedBy">{{formLabels.user.create.projectAdmin.title}}</span>
                        <span *ngIf="!restrictedBy">{{formLabels.user.create.systemAdmin.title}}</span>
                    </mat-panel-title>
                    <mat-panel-description
                        *ngIf="!form.controls['givenName'].value && !form.controls['familyName'].value">
                        <span *ngIf="restrictedBy">{{formLabels.user.create.projectAdmin.description}}</span>
                        <span *ngIf="!restrictedBy">{{formLabels.user.create.systemAdmin.description}}</span>
                        <mat-icon>person_add</mat-icon>
                    </mat-panel-description>
                    <mat-panel-description *ngIf="form.controls['givenName'].value && form.controls['familyName'].value">
                        {{form.controls['givenName'].value}} {{form.controls['familyName'].value}}
                        <mat-icon>person_add</mat-icon>
                    </mat-panel-description>
                </mat-expansion-panel-header>

                <!-- step 1 form content -->
                <form class="salsah-form new-user" [formGroup]="form">
                    <mat-form-field class="small">
                        <input matInput [salsahFocus]="step === 1"
                               [placeholder]="formLabels.user.create.givenName + ' *'"
                               [formControl]="form.controls['givenName']">
                        <mat-hint *ngIf="formErrors.givenName">
                            {{ formErrors.givenName }}
                        </mat-hint>
                    </mat-form-field>
                    <mat-form-field class="medium">
                        <input matInput
                               [placeholder]="formLabels.user.create.familyName + ' *'"
                               [formControl]="form.controls['familyName']">
                        <mat-hint *ngIf="formErrors.familyName">
                            {{ formErrors.familyName }}
                        </mat-hint>
                    </mat-form-field>
                    <!-- email = username -->
                    <mat-form-field class="large">
                        <input matInput type="email" class="full-width"
                               [placeholder]="formLabels.user.create.email + ' *'"
                               [formControl]="form.controls['email']">
                        <mat-hint *ngIf="formErrors.email">
                            {{ formErrors.email }}
                        </mat-hint>
                    </mat-form-field>
                    <!-- password -->
                    <mat-form-field class="large">
                        <input matInput [type]="showPassword ? 'text' : 'password'"
                               [placeholder]="formLabels.user.create.password + ' *'"
                               [formControl]="form.controls['password']">
                        <mat-icon matSuffix class="input-icon icon-for-password" (click)="toggleVisibility()"
                                 [innerHtml]="showPassword ? 'visibility_off' :'visibility'"></mat-icon>
                        <mat-hint *ngIf="formErrors.password">
                            {{ formErrors.password }}
                        </mat-hint>
                    </mat-form-field>

                    <mat-select class="large"
                               [placeholder]="formLabels.user.create.language"
                               [formControl]="form.controls['lang']">

                        <mat-option value="en">english</mat-option>
                        <mat-option value="de">deutsch</mat-option>
                        <mat-option value="fr">fran√ßais</mat-option>
                        <mat-option value="it">italiano</mat-option>
                    </mat-select>

                </form>

                <!-- footer -->
                <mat-action-row>
                    <button mat-button
                            color="warn"
                            (click)="form.reset()">
                        {{formLabels.navigation.reset}}
                    </button>
                    <button mat-button *ngIf="restrictedBy"
                            class="navigation-button"
                            color="primary"
                            (click)="nextStep($event, 3)"
                            [disabled]="!form.valid">
                        {{formLabels.navigation.next}}
                    </button>
                    <button mat-button *ngIf="!restrictedBy"
                            class="navigation-button"
                            color="primary"
                            (click)="nextStep($event)"
                            [disabled]="!form.valid">
                        {{formLabels.navigation.next}}
                    </button>
                </mat-action-row>

            </mat-expansion-panel>
            <!-- ////////////////////////////////////////////////////////////////////////////////// -->

            <!-- 2) project membership -->

            <!-- 2a) view: system admin: select project AND set the permissions => b) -->
            <mat-expansion-panel [expanded]="step === 2" *ngIf="!restrictedBy"
                                (opened)="setStep(2)"
                                hideToggle="true">
                <!-- header -->
                <mat-expansion-panel-header>
                    <mat-panel-title>
                        {{formLabels.project.select.title}}
                    </mat-panel-title>
                    <!-- 2a) show the project short name only -->
                    <mat-panel-description>
                        {{formLabels.project.select.description}}
                        <mat-icon>assignment</mat-icon>
                    </mat-panel-description>
                </mat-expansion-panel-header>
                <mat-form-field class="large">
                    <input matInput
                           [placeholder]="formLabels.project.select.autoComplete"
                           [matAutocomplete]="autoProject"
                           [formControl]="projectCtrl">
                    <mat-icon matSuffix class="input-icon icon-for-autocomplete" (click)="projectCtrl.reset()"
                             *ngIf="projectCtrl.value && projectCtrl.dirty">close
                    </mat-icon>
                    <mat-autocomplete #autoProject="matAutocomplete"> <!-- [displayWith]="displayFn"> -->
                        <mat-option *ngFor="let project of filteredProjects | async" [value]="project?.name"
                                   (onSelectionChange)="setSelectedProject($event, project?.iri)">
                            {{ project?.name }}
                        </mat-option>
                    </mat-autocomplete>
                </mat-form-field>
                <!-- footer -->
                <mat-action-row>
                    <button mat-button
                            class="navigation-button left"
                            color="warn"
                            (click)="skipStep($event, 4, 'project')">
                        {{formLabels.project.select.skip}}
                    </button>
                    <button mat-button
                            class="navigation-button"
                            color="primary"
                            (click)="nextStep($event)"
                            [disabled]="!projectCtrl.valid">
                        {{formLabels.navigation.next}}
                    </button>
                </mat-action-row>


                <!--

                <mat-input-container class="full-width">
                    <input matInput
                           [matAutocomplete]="users"
                           [formControl]="userCtrl"
                           [placeholder]="formLabels.select">
                    <mat-icon matSuffix class="input-icon icon-for-autocomplete" (click)="userCtrl.reset()"
                             *ngIf="userCtrl.value && userCtrl.dirty">close</mat-icon>
                </mat-input-container>
                <mat-autocomplete #users="matAutocomplete" [displayWith]="displayFn">
                    <mat-option *ngFor="let user of filteredUsers | async" [value]="user.name"
                               (onSelectionChange)="getUser(user?.iri)">
                        {{ user?.name }}
                    </mat-option>
                </mat-autocomplete>
                <mat-action-row>
                    <button mat-button
                            class="navigation-button center"
                            color="primary"
                            (click)="nextStep($event)"
                            [disabled]="!form.valid">
                        {{formLabels.navigation.next}}
                    </button>
                </mat-action-row>
                -->

            </mat-expansion-panel>

            <!-- 2b) view: project and system admin: set permissions -->
            <mat-expansion-panel [expanded]="step === 3"
                                (opened)="setStep(3)"
                                hideToggle="true">
                <!-- header -->
                <mat-expansion-panel-header>
                    <mat-panel-title>
                        {{formLabels.permissions.title}}
                    </mat-panel-title>
                    <mat-panel-description>
                        <span>{{formLabels.permissions.description}}</span>
                        <mat-icon>accessibility</mat-icon>
                    </mat-panel-description>
                </mat-expansion-panel-header>
                <mat-list>
                    <div>
                        <h3 mat-subheader>
                            {{formLabels.permissions.project.title}}
                            <span *ngIf="selectedProject"><i>{{selectedProject?.longname}}</i></span>
                        </h3>
                        <mat-list-item>
                            <mat-slide-toggle [(ngModel)]="adminPermission"
                                             [disabled]="!projectIri && (!selectedUser && !form.valid)"
                                             color="primary">
                                {{formLabels.permissions.project.description}}
                            </mat-slide-toggle>
                        </mat-list-item>
                    </div>
                    <div *ngIf="sysAdmin && !userIri">
                        <h3 mat-subheader>{{formLabels.permissions.system.title}}</h3>
                        <mat-list-item>
                            <mat-slide-toggle [(ngModel)]="sysAdminPermission"
                                             [disabled]="!projectIri && (!selectedUser && !form.valid)"
                                             color="primary">
                                {{formLabels.permissions.system.description}}
                            </mat-slide-toggle>
                        </mat-list-item>
                    </div>


                </mat-list>

                <!-- footer -->
                <mat-action-row>
                    <button mat-button
                            class="navigation-button"
                            color="primary"
                            (click)="nextStep($event)">
                        {{formLabels.navigation.next}}
                    </button>
                </mat-action-row>

            </mat-expansion-panel>

            <!-- ////////////////////////////////////////////////////////////////////////////////// -->

            <!-- 3) overview or additional form stuff -->
            <mat-expansion-panel [expanded]="step === 4"
                                (opened)="setStep(4)"
                                hideToggle="true">
                <!-- header -->
                <mat-expansion-panel-header>
                    <mat-panel-title>
                        {{formLabels.overview.title}}
                    </mat-panel-title>
                    <mat-panel-description>
                        {{formLabels.overview.description}}
                        <mat-icon>done</mat-icon>
                    </mat-panel-description>
                </mat-expansion-panel-header>

                <!-- name / email of selected user -->
                <mat-list>
                    <mat-list-item *ngIf="selectedUser || form.valid">
                        <salsah-progress-indicator mat-list-avatar class="salsah-avatar" [type]="'submit'"
                                                   [status]="submitUserStatus"></salsah-progress-indicator>
                        <h4 mat-line>
                            <span *ngIf="selectedUser">
                                {{formLabels.user.select.titleDone}}
                            </span>
                            <span *ngIf="!selectedUser && form.valid">
                                {{formLabels.user.create.projectAdmin.titleDone}}
                            </span>
                        </h4>
                        <p mat-line>
                            <span *ngIf="selectedUser">
                                {{selectedUser.userData?.givenName}} {{selectedUser.userData?.familyName}}, {{selectedUser.userData?.email}}
                            </span>
                            <span *ngIf="!selectedUser && form.valid">
                                {{form.controls['givenName'].value}} {{form.controls['familyName'].value}}, {{form.controls['email'].value}}
                            </span>
                        </p>
                        <mat-hint mat-line *ngIf="userErrorMessage" class="salsah-error-message">
                            {{userErrorMessage?.statusText}}
                        </mat-hint>
                    </mat-list-item>
                </mat-list>

                <mat-list *ngIf="restrictedBy || selectedProject">
                    <mat-list-item *ngIf="restrictedBy || selectedProject">
                        <salsah-progress-indicator mat-list-avatar class="salsah-avatar" [type]="'submit'"
                                                   [status]="submitProjectStatus"></salsah-progress-indicator>
                        <h4 mat-line>
                            {{formLabels.project.select.title}}
                        </h4>
                        <p mat-line>
                            {{selectedProject?.longname}} ({{selectedProject?.shortname}})
                        </p>
                        <mat-hint mat-line *ngIf="projectErrorMessage" class="salsah-error-message">
                            {{projectErrorMessage?.statusText}}
                        </mat-hint>
                    </mat-list-item>
                    <mat-list-item>
                        <salsah-progress-indicator mat-list-avatar class="salsah-avatar" [type]="'submit'"
                                                   [status]="submitPermissionsStatus"></salsah-progress-indicator>
                        <h4 mat-line>
                            {{formLabels.permissions.title}}
                        </h4>
                        <p mat-line>
                            <span *ngIf="adminPermission">&bull; {{formLabels.permissions.project.description}}</span>
                            <span *ngIf="sysAdminPermission"><br>&bull; {{formLabels.permissions.system.description}}</span>
                        </p>
                        <mat-hint mat-line *ngIf="permissionsErrorMessage" class="salsah-error-message">
                            {{permissionsErrorMessage?.statusText}}
                        </mat-hint>
                    </mat-list-item>
                </mat-list>

                <!-- footer -->
                <mat-action-row>
                    <!-- two buttons for both cases and to submit the data with the method -->
                    <div *ngIf="!afterSubmit">
                        <button mat-raised-button *ngIf="!selectedUser" [disabled]="!form.valid"
                                color="primary"
                                (click)="submitData()">
                            {{formLabels.navigation.submit}}
                        </button>
                        <button mat-raised-button *ngIf="selectedUser" [disabled]="!selectedUser?.userData?.user_id"
                                color="primary"
                                (click)="submitData()">
                            {{formLabels.navigation.submit}}
                        </button>
                    </div>
                    <!-- one button to add more users and on button to close the form;
                        both button are shown after submit -->
                    <div *ngIf="(!userErrorMessage && !projectErrorMessage && !permissionsErrorMessage) && afterSubmit">
                        <button mat-button
                                color="primary"
                                (click)="resetForm()">
                            {{formLabels.navigation.add}}
                        </button>
                        <button mat-button mat-dialog-close
                                class="navigation-button-center"
                                color="warn"
                                (click)="updateView()">
                            {{formLabels.navigation.close}}
                        </button>
                    </div>
                    <!--
                    <button mat-button (click)="resetForm()">
                        TEST
                    </button>
                    -->

                </mat-action-row>

            </mat-expansion-panel>


        </mat-accordion>
    </div>


</div>

<!-- next section
{{formLabels.system.admin}}
                                    <mat-slide-toggle [color]="'primary'" [formControl]="form.controls['systemAdmin']"
                                                     [(ngModel)]="form.controls['systemAdmin'].value">
                                    </mat-slide-toggle>
                                    -->


<!--
                        <table class="full-width" cellspacing="0">
                            <!-- line 1: pre and last name --
                            <tr>
                                <td colspan="1">
                                    <mat-input-container class="full-width"
                                                        dividerColor="{{ form.controls['givenName']?.invalid && form.controls['givenName']?.touched ? 'warn' : 'primary' }}">
                                        <input matInput
                                               [placeholder]="formLabels.user.givenName + ' *'"
                                               [formControl]="form.controls['givenName']">
                                    </mat-input-container>
                                </td>
                                <td colspan="2">
                                    <mat-input-container class="full-width"
                                                        dividerColor="{{ form.controls['familyName']?.invalid && form.controls['familyName']?.touched ? 'warn' : 'primary' }}">
                                        <input matInput
                                               [placeholder]="formLabels.user.familyName + ' *'"
                                               [formControl]="form.controls['familyName']">
                                    </mat-input-container>
                                </td>
                            </tr>
                            <!-- line 2: eMail address --
                            <tr>
                                <td colspan="3">
                                    <mat-input-container class="full-width"
                                                        dividerColor="{{ form.controls['email']?.invalid && form.controls['email']?.touched ? 'warn' : 'primary' }}">
                                        <input matInput type="email"
                                               [placeholder]="formLabels.user.email + ' *'"
                                               [formControl]="form.controls['email']">
                                        <mat-hint class="salsah-hint">
                                            <span [hidden]="form.controls['email'].invalid">{{formLabels.user.emailHint}}</span>
                                            <span
                                                [hidden]="form.controls['email'].valid && form.controls['email'].dirty || !form.controls['email'].touched"
                                                class="salsah-error">{{formLabels.user.emailValidation}}
                                    </span>
                                        </mat-hint>
                                    </mat-input-container>
                                </td>
                            </tr>
                            <!-- line 3: password --
                            <tr>
                                <td colspan="3">
                                    <mat-input-container class="full-width"
                                                        dividerColor="{{ !form.controls['password']?.valid ? 'warn' : 'primary' }}">
                                        <input matInput type="password"
                                               [placeholder]="formLabels.user.password + ' *'"
                                               [formControl]="form.controls['password']">
                                        <mat-hint class="salsah-hint">
                                            <!-- [hidden]="form.controls['password'].valid" [ngClass]="{'salsah-error': (form.controls['password'].invalid && form.controls['password'].dirty)}"  --
                                            <span
                                                [hidden]="form.controls['password'].valid && form.controls['password'].dirty || form.controls['password'].touched"
                                                class="salsah-error">
                                        {{formLabels.user.passwordHint}}
                                    </span>
                                        </mat-hint>
                                    </mat-input-container>
                                </td>
                            </tr>
                            <!-- line 4: preferred language --
                            <tr>
                                <td colspan="2">
                                    <mat-select [formControl]="form.controls['lang']"
                                               [placeholder]="formLabels.user.language"
                                               [(ngModel)]="form.controls['lang'].value">
                                        <mat-option value="en">english</mat-option>
                                        <mat-option value="de">deutsch</mat-option>
                                        <mat-option value="fr">fran√ßais</mat-option>
                                        <mat-option value="it">italiano</mat-option>
                                    </mat-select>
                                </td>
                                <td>
                                    {{formLabels.system.admin}}
                                    <mat-slide-toggle [color]="'primary'" [formControl]="form.controls['systemAdmin']"
                                                     [(ngModel)]="form.controls['systemAdmin'].value">
                                    </mat-slide-toggle>
                                </td>
                            </tr>
                        </table>

                        <mat-action-row>
                            <button mat-button
                                    class="navigation-button center"
                                    color="primary"
                                    (click)="nextStep($event)"
                                    [disabled]="!form.valid">
                                Next
                            </button>
                        </mat-action-row>
-->
